# medical_knowledge.py

# קואורדינטות ברירת מחדל
DEFAULT_BODY_COORDS = {
    "ראש - קדמי": [150, 40], "צוואר - קדמי": [150, 85],
    "כתף ימין - קדמי": [95, 120], "כתף שמאל - קדמי": [205, 120],
    "חזה": [150, 150], "בטן": [150, 240],
    "מרפק ימין - קדמי": [70, 210], "מרפק שמאל - קדמי": [230, 210],
    "אגן - קדמי": [150, 290],
    "ברך ימין - קדמי": [115, 460], "ברך שמאל - קדמי": [185, 460],
    "קרסול ימין - קדמי": [115, 580], "קרסול שמאל - קדמי": [185, 580],
    "ראש - אחורי": [450, 40], "צוואר - אחורי": [450, 85],
    "כתף ימין - אחורי": [505, 120], "כתף שמאל - אחורי": [395, 120],
    "גב עליון": [450, 160], "גב תחתון": [450, 240],
    "מרפק ימין - אחורי": [530, 210], "מרפק שמאל - אחורי": [370, 210],
    "אגן - אחורי": [450, 310],
    "ברך ימין - אחורי": [485, 460], "ברך שמאל - אחורי": [415, 460],
    "קרסול ימין - אחורי": [490, 580], "קרסול שמאל - אחורי": [410, 580]
}

# המילון הרפואי החכם
MEDICAL_BRAIN = {
    "hpc": [
        "נפלתי", "תאונה", "מכה", "חבלה", "וויפלש", "סיבוב", "עומס", "תנועות", 
        "פתאום", "ללא סיבה", "קליק", "פופ", "קריעה", "חוסר יציבות", "בריחה", 
        "נעילה", "נפיחות", "כואב לי", "התחיל", "לפני", "כאבים"
    ],
    "gh": [
        "סוכרת", "לחץ דם", "לב", "סרטן", "ירידה במשקל", "הזעות", "חום", 
        "סחרחורות", "קוצר נשימה", "אסתמה", "עישון", "אלכוהול", "אוסטאופורוזיס", 
        "ניתוח", "שבר", "רקע רפואי", "בריא", "מחלות"
    ],
    "med": [
        "תרופה", "כדור", "אקמול", "אופטלגין", "נורופן", "אדוויל", "ארקוקסיה", 
        "אתופן", "סטרואידים", "זריקה", "סי טי", "MRI", "רנטגן", "אולטרסאונד", 
        "מרשם", "טיפול"
    ],
    "agg": [
        "הליכה", "עמידה", "ישיבה", "כיפוף", "יישור", "רוטציה", "הרמה", 
        "מאמץ", "מדרגות", "ריצה", "מחמיר", "כואב יותר"
    ],
    "ease": [
        "מנוחה", "שכיבה", "רגליים למעלה", "חימום", "קרח", "מקלחת", "עיסוי", 
        "תנועה קלה", "מקל", "עוזר", "מרגיע"
    ],
    "night": [
        "לילה", "שינה", "נרדם", "מתעורר", "כאב בלילה", "לא ישן"
    ],
    "wake": [
        "בוקר", "קם", "נוקשות", "צעדים ראשונים", "תפוס בבוקר"
    ],
    "soc": [
        "עובד", "פנסיה", "משרד", "פיזי", "סטודנט", "נשוי", "רווק", "ילדים", 
        "קומה", "מעלית", "ספורט", "חדר כושר"
    ],
    "exp": [
        "לחזור", "לרוץ", "ללכת", "לעבוד", "לישון", "בלי כאב", "ציפייה"
    ]
}

def analyze_text_engine(text):
    results = {"body_parts": [], "pain": 0, "fields": {}}
    t = text.replace(",", "").replace(".", "")
    words = t.split()
    
    # מיפוי גוף
    side = "שמאל" if "שמאל" in t else "ימין"
    view = "אחורי" if any(w in t for w in ["גב", "אחור", "עורף", "ישבן"]) else "קדמי"
    
    potential_parts = {
        "כתף": f"כתף {side} - {view}", "ברך": f"ברך {side} - {view}",
        "ראש": f"ראש - {view}", "צוואר": f"צוואר - {view}",
        "גב תחתון": "גב תחתון", "גב": "גב עליון", "אגן": f"אגן - {view}",
        "מרפק": f"מרפק {side} - {view}", "קרסול": f"קרסול {side} - {view}"
    }
    
    for key, val in potential_parts.items():
        if key in t: results["body_parts"].append(val)

    # זיהוי כאב
    for w in words:
        if w.isdigit():
            val = int(w)
            if 0 <= val <= 10: results["pain"] = val

    # מיון לשדות
    for category, keywords in MEDICAL_BRAIN.items():
        found_snippets = []
        for key in keywords:
            if key in t:
                try:
                    idx = words.index(key)
                    start = max(0, idx - 2)
                    end = min(len(words), idx + 5)
                    snippet = " ".join(words[start:end])
                    found_snippets.append(snippet)
                except:
                    found_snippets.append(key)
        
        if found_snippets:
            results["fields"][category] = " | ".join(list(set(found_snippets)))
            
    return results